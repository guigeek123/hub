version: '2.3'
# Starting with the 2019.2.0 release: DO NOT EDIT THIS FILE!!!
# ADD ANY OF YOUR OVERRIDES IN THE docker-compose.local-overrides.yml FILE
# Refer to the Release Notes or Installation Guide for more information.

# Deprecating Docker Compose Support
# Synopsys will be deprecating support for Docker Compose  starting with the Black Duck 2019.4.0 release.  
# Docker Compose will be supported until December 31, 2019.

services:
  simpleproxy:
    image: benappsec/simple_proxy:0.2
    environment:
      - http_proxy=http://foo:bar@squid:3128
      - https_proxy=http://foo:bar@squid:3128
    networks:
      - no-internet
  squid:
    image: guigeek123/mysquid:1.0
    environment:
      - SQUID_USERNAME=foo
      - SQUID_PASSWORD=bar
    networks:
      - no-internet
      - internet
  busybox:
    image: busybox
    networks:
      - no-internet
    entrypoint: tail -f /dev/null
  postgres:
    image: blackducksoftware/blackduck-postgres:1.0.7
    ports: ['55436:5432']
    links: [cfssl, logstash]
    volumes: ['postgres96-data-volume:/var/lib/postgresql/data']
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 7200s
    user: postgres:root
    mem_limit: 3072M
    restart: always
    stop_grace_period: 60s
    networks:
      - no-internet
  authentication:
    links: [postgres, cfssl, logstash, registration, zookeeper, webapp]
    user: authentication:root
    image: blackducksoftware/blackduck-authentication:2019.6.0
    volumes: ['authentication-volume:/opt/blackduck/hub/hub-authentication/ldap' ]
    env_file: [blackduck-config.env ]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/api/health-checks/liveness',
        /opt/blackduck/hub/hub-authentication/security/root.crt, /opt/blackduck/hub/hub-authentication/security/blackduck_system.crt,
        /opt/blackduck/hub/hub-authentication/security/blackduck_system.key]
      interval: 30s
      timeout: 60s
      retries: 15
      start_period: 7200s
    environment: {HUB_MAX_MEMORY: 512m}
    tmpfs: [/opt/blackduck/hub/hub-authentication/security]
    restart: always
    mem_limit: 1024M
    networks:
      - no-internet
  webapp:
    links: [postgres, cfssl, logstash, registration, zookeeper]
    user: tomcat:root
    image: blackducksoftware/blackduck-webapp:2019.6.0
    volumes: ['log-volume:/opt/blackduck/hub/logs', 'webapp-volume:/opt/blackduck/hub/hub-webapp/ldap' ]
    env_file: [blackduck-config.env ]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/api/health-checks/liveness',
        /opt/blackduck/hub/hub-webapp/security/root.crt, /opt/blackduck/hub/hub-webapp/security/blackduck_system.crt,
        /opt/blackduck/hub/hub-webapp/security/blackduck_system.key]
      interval: 30s
      timeout: 60s
      retries: 15
      start_period: 7200s
    environment: {HUB_MAX_MEMORY: 2048m}
    tmpfs: [/opt/blackduck/hub/hub-webapp/security]
    restart: always
    mem_limit: 2560M
    networks:
      - no-internet
  scan:
    links: [postgres, cfssl, logstash, registration, zookeeper]
    user: scan:root
    image: blackducksoftware/blackduck-scan:2019.6.0
    volumes: [  ]
    env_file: [blackduck-config.env ]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/api/health-checks/liveness',
        /opt/blackduck/hub/hub-scan/security/root.crt, /opt/blackduck/hub/hub-scan/security/blackduck_system.crt,
        /opt/blackduck/hub/hub-scan/security/blackduck_system.key]
      interval: 30s
      timeout: 60s
      retries: 15
      start_period: 7200s
    environment: {HUB_MAX_MEMORY: 2048m}
    tmpfs: [/opt/blackduck/hub/hub-scan/security]
    restart: always
    mem_limit: 2560M
    networks:
      - no-internet
  jobrunner:
    links: [postgres, cfssl, logstash, registration, zookeeper]
    user: jobrunner:root
    image: blackducksoftware/blackduck-jobrunner:2019.6.0
    volumes: [  ]
    env_file: [blackduck-config.env ]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh]
      interval: 30s
      timeout: 60s
      retries: 15
      start_period: 7200s
    environment: {HUB_MAX_MEMORY: 4096m}
    tmpfs: [/opt/blackduck/hub/jobrunner/security]
    restart: always
    mem_limit: 4608M
    networks:
      - no-internet
  cfssl:
    image: blackducksoftware/blackduck-cfssl:1.0.0
    volumes: ['cert-volume:/etc/cfssl']
    env_file: [blackduck-config.env]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'http://localhost:8888/api/v1/cfssl/scaninfo']
      interval: 30s
      timeout: 10s
      retries: 5
    user: cfssl:root
    restart: always
    mem_limit: 512M
    networks:
      - no-internet
  logstash:
    image: blackducksoftware/blackduck-logstash:1.0.4
    volumes: ['log-volume:/var/lib/logstash/data']
    env_file: [blackduck-config.env]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'http://localhost:9600/']
      interval: 30s
      timeout: 10s
      retries: 5
    user: logstash:root
    environment: {DAYS_TO_KEEP_LOGS: 30}
    restart: always
    mem_limit: 1024m
    networks:
      - no-internet
  registration:
    image: blackducksoftware/blackduck-registration:2019.6.0
    links: [logstash, cfssl]
    volumes: ['config-volume:/opt/blackduck/hub/hub-registration/config']
    env_file: [blackduck-config.env]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/registration/health-checks/liveness',
        /opt/blackduck/hub/hub-registration/security/root.crt, /opt/blackduck/hub/hub-registration/security/blackduck_system.crt,
        /opt/blackduck/hub/hub-registration/security/blackduck_system.key]
      interval: 30s
      timeout: 10s
      retries: 5
    user: registration:root
    tmpfs: [/opt/blackduck/hub/hub-registration/security]
    restart: always
    mem_limit: 640M
    networks:
      - no-internet
  zookeeper:
    image: blackducksoftware/blackduck-zookeeper:1.0.0
    links: [logstash]
    volumes: ['zookeeper-data-volume:/opt/blackduck/zookeeper/data', 'zookeeper-datalog-volume:/opt/blackduck/zookeeper/datalog']
    env_file: [blackduck-config.env]
    healthcheck:
      test: [CMD, zkServer.sh, status, /opt/blackduck/zookeeper/conf/zoo.cfg]
      interval: 30s
      timeout: 10s
      retries: 5
    user: zookeeper:root
    restart: always
    mem_limit: 384M
    networks:
      - no-internet
  webserver:
    image: blackducksoftware/blackduck-nginx:1.0.7
    ports: ['443:8443']
    env_file: [hub-webserver.env, blackduck-config.env]
    links: [webapp, cfssl, documentation, authentication, scan]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/health-checks/liveness',
        /opt/blackduck/hub/webserver/security/root.crt]
      interval: 30s
      timeout: 10s
      retries: 5
    user: nginx:root
    restart: always
    mem_limit: 640M
    tmpfs: [/opt/blackduck/hub/webserver/security]
    networks:
      - no-internet
  documentation:
    image: blackducksoftware/blackduck-documentation:2019.6.0
    links: [logstash]
    env_file: [blackduck-config.env]
    user: tomcat:root
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://127.0.0.1:8443/hubdoc/health-checks/liveness',
        /opt/blackduck/hub/hub-documentation/security/root.crt]
      interval: 30s
      timeout: 10s
      retries: 5
    tmpfs: [/opt/blackduck/hub/hub-documentation/security]
    restart: always
    mem_limit: 512M
    networks:
      - no-internet
  uploadcache:
      image: blackducksoftware/blackduck-upload-cache:1.0.8
      volumes: ['uploadcache-volume:/opt/blackduck/hub/blackduck-upload-cache/uploads', 'uploadcache-keys-volume:/opt/blackduck/hub/blackduck-upload-cache/keys']
      links:
        - cfssl
        - logstash
      healthcheck:
        test: [CMD, /usr/local/bin/healthcheck.sh, 'https://localhost:8086/live?full=1', /opt/blackduck/hub/blackduck-upload-cache/security/root.crt]
        interval: 30s
        timeout: 10s
        retries: 5
      tmpfs: [/opt/blackduck/hub/blackduck-upload-cache/security]
      env_file: [blackduck-config.env]
      user: 'uploadcache:root'
      restart: always
      networks:
        - no-internet
volumes: {postgres96-data-volume: null, authentication-volume: null, cert-volume: null,
  config-volume: null, log-volume: null, webapp-volume: null,
  monitor-log-volume: null, zookeeper-data-volume: null, zookeeper-datalog-volume: null, uploadcache-volume: null, uploadcache-keys-volume: null  }

networks:
  no-internet:
    driver: bridge
    internal: true
  internet:
    driver: bridge

